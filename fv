#!/bin/sh
# fv - archive and package directory lister
# Place into the public domain by Dan Fandrich <dan@coneharvesters.com>
# $Id: fv,v 1.14 2005/12/09 06:33:51 dan Exp $
#
# $Log: fv,v $
# Revision 1.14  2005/12/09 06:33:51  dan
# Added .pq6 type and some minor edits.
#
# Revision 1.13  2005/11/30 07:52:37  dan
# Improved -v -l to display alternate descriptions of archive types.
#
# Revision 1.12  2005/11/13 06:23:23  dan
# Added .sxi, .sxd types.  Cleaned up some of the comments.
#
# Revision 1.11  2005/10/25 05:40:26  dan
# Added .kmz, .tbz, .fpm, .pbi, .alz archive types.
# Added verbose version of -l listing.
#
# Revision 1.10  2005/05/11 07:03:20  dan
# Added rzip support. Added -v option to display archive type.
#
# Revision 1.9  2005/02/24 07:55:23  dan
# Eliminated use of temporary files for .deb and .ipk file types, thereby
# closing a security hole.
# Added -t option to select a specific archive type for a file.
# Renamed CBM .arc to .cbmarc
# Improve detection of .ipk format version.
# Added winmail.dat type.
#
# Revision 1.8  2005/02/03 05:37:02  dan
# No longer abort if one archive type isn't known.
# Bumped version to 1.2.
#
# Revision 1.7  2004/12/02 05:51:30  dan
# Added .7z, .wal, .wsz, .tardist, .depot.gz
#
# Revision 1.6  2004/07/10 22:51:32  dan
# Added untested extensions .bun .dar .mar (different) .par .par2 .spark .zz
# Improved .deb .ipk
# Made -l work on a greater variety of systems
#
# Revision 1.5  2004/07/08 05:49:01  dan
# Added file extensions .sis .chm .slp .ace
# Added -l option to display supported file extensions.
#
# Revision 1.4  2003/06/03 06:16:48  dan
# Added old .ipk style.
# Added .qpk, .cpio.bz2
# Extract temporary achives in /tmp
#
# Revision 1.3  2003/04/02 07:23:15  dan
# Changed return code for argument error.
#
# Revision 1.2  2003/04/02 06:37:53  dan
# Bumped version number to 1.1.
# Exit with the archive list command exit code (in most cases).
# Added many archive types.
# Added comments about package dependencies for displaying each archive type.
#
# 96-11-23  ver. 1.0  Dan Fandrich  first public release
# 95-11-23  ver. 0.1  Dan Fandrich  <dan@fch.wimsey.bc.ca> created
#
# The requires: lines below the archive name refer to the package(s) required
# by fv to list the archive contents (RedHat package names are listed in
# most cases).
#
# TO DO:
#  - See Wikipedia: http://en.wikipedia.org/wiki/List_of_archive_formats
#  - look into POSIX package tools (e.g. http://www.gnu.org/software/swbis/)
#  - add .dmg type using the Mac OS X diskutil program
#  - if type can't be determined, determine type using 'file'
#	 - make a big switch statement taking in file's output and returning
#      file extension
#    - separate switch statement using file's --mime option if available

if [ X"$1" = X"-v" ] ; then
	FV_VERBOSE=1
	shift
fi

if [ $# -eq 0 -o X"$1" = X"-?" -o X"$1" = X"-h"  ] ; then
	echo 'fv ver. 1.2.2'
	echo 'Usage: fv [-v] [-?] [-h] [-l] [-t type] archive1 [ archive2 ... ]'
	echo 'Displays directory listings for many archive types.'
	exit 3
fi

if [ X"$1" = X"-l" ] ; then
	# requires: textutils, sed
	if [ X"$FV_VERBOSE" = X1 ] ; then
		# Scan this script looking for archive label lines and Also comments
		sed -n -e "s/'//g" -e 's/^[^#]\+archive[_]label //p' \
		 -e 's/^[ 	]*# Also \(.*\) [a-z0-9A-Z\.,]*$/\1/p' "$0" | sort -f
	else
		echo 'Supported file extensions:'
		# Scan this script looking for wildcard case statement entries
		sed -n -e 's/^[ 	][ 	]*\(\*[^#)]*\)[)\\].*$/\1/p' "$0" | sed -e 's/ *| */\
/g' | sed -e 's/\*//g' -e '/^\**$/d' | sort -f | fmt
	fi
	exit
fi

staticfiletype=""
if [ X"$1" = X"-t" ] ; then
	staticfiletype="$2"
	# Make sure file type starts with . for comparision purposes
	case "$staticfiletype" in
		.*) ;;
		 *)	staticfiletype=".$staticfiletype"
		    ;;
	esac
	shift
	shift
fi

archive_label () {
	# Display the archive name in verbose mode
	if [ X"$FV_VERBOSE" = X1 ] ; then
		echo "$*"
	fi
}

for f in "$@" ; do
	if [ X"$staticfiletype" = X"" ] ; then
		filetype=`basename "$f"`
	else
		filetype="$staticfiletype"
	fi
	echo "$f":
	case "$filetype" in
		# see http://www.p7zip.sf.net/
		# requires: p7zip
		*.7z)	archive_label 7zip archive
			7za l "$f"
			;;

		# requires: binutils
		*.a | *.sa)	archive_label ar archive
			ar tv "$f"
			;;

		# requires: linunace
		*.ace)	archive_label ACE archive 
			unace v "$f"
			;;

		# See http://www.kipple.pe.kr/win/unalz/
		# requires: unalz
		*.alz)	archive_label ALZ archive
			unalz -l "$f"
			;;

		# requires: arc
		*.arc)	archive_label SEA ARC archive
			arc v "$f"
			;;

		# requires: nspark
		# Extension is really .arc, but that conflicts with SEA ARC
		*.spark)	archive_label Archimedes Spark archive '(RiscOS)'
			nspark -l -v "$f"
			;;

		# requires: unarj
		*.arj)	archive_label ARJ archive
			unarj l "$f"
			;;

		# See http://www.star.le.ac.uk/~tjg/bun/
		# requires: bun
		# (Untested)
		*.bun)	archive_label BUN archive
			bun tv "$f"
			;;

		# requires: cabextract
		*.cab)	archive_label Microsoft Cabinet archive
			cabextract -l "$f"
			;;

		# snd+gfx--see sasteroids
		*.cf)	archive_label Compound File Compiler archive
			cvf "$f"
			;;

		# requires: chmlib
		*.chm)	archive_label Microsoft Compressed HTML
			enum_chmLib "$f"
			;;

		# requires: cpio, gzip
		*.cpio.gz | *.cpio.Z | *.cpio.z | *.cgz)	
			archive_label compressed cpio archive
			gzip -dc "$f" | cpio --list --verbose
			;;

		# requires: cpio, bzip2
		*.cpio.bz2)	archive_label bzip2-compressed cpio archive
			bzip2 -dc "$f" | cpio --list --verbose
			;;

		# requires: cpio
		*.cpio)	archive_label cpio archive
			cpio --list --verbose < "$f"
			;;

		# See http://dar.linux.free.fr/
		# requires: dar
		# (Untested)
		# May need `basename "`basename "$f"`"`
		*.dar)	archive_label Disk Archiver archive
			dar -l "$f"
			;;

		# requires: binutils, tar
		# On a Debian system, this should use 'dpkg -c "$f"' instead
		*.deb)  archive_label Debian distribution archive
			ar p "$f" data.tar.gz | gzip -dc | tar tvf -
			;;

		# See http://www.handhelds.org/
		# requires: binutils, file, grep, gzip, tar
		*.ipk)	archive_label Itsy Package
			# Detect the old or new style ipk format
			if file "$f" | egrep -iq 'Debian|ar archive' ; then
				ar p "$f" data.tar.gz | gzip -dc | tar tvf -
			else
				# Internal file name may or may not be prefixed with ./
				# which is what the \* catches.
				gzip -dc "$f" | tar xOf - \*data.tar.gz | gzip -dc | tar tvf -
			fi
			;;

		# I've forgotten what this is
		*.ha)	archive_label ha archive
			ha l "$f"
			;;

		# requires: sed
		*.hp)	archive_label HP48 distribution archives as posted to comp.sources.hp48
			sed -n -e 's/^\(BEGIN_.*\) /\1	/p' "$f"
			;;

		# requires: macutils
		*.hqx)	archive_label Macintosh BinHex encoding
			hexbin -il "$f"
			;;

		# requires: cdrecord
		*.iso)	archive_label ISO9660 filesystem image file
			isoinfo -l -R -i "$f"
			;;

		# requires: lha
		*.lha | *.lzh)	archive_label LHARC archive
			lha v "$f"
			;;

		# See http://www.lzop.org/
		# requires: lzop
		*.lzo)	archive_label LZOP compressed file
			lzop -vl "$f"
			;;

		# (Is .mac the most common suffix for MacBinary files?)
		# requires: macutils
		*.mac)	archive_label Macintosh MacBinary encoding
			macsave -il < "$f"
			;;

		# Found this one on SCO UNIX
		# (Don't know what kind of suffix this one uses)
		# (Untested)
		#*.mar)	archive_label Message catalogue archive
		#	mar tv "$f"
		#	;;

		# See http://www.emantic.co.uk/mark/
		# requires: mar
		# (Untested)
		*.mar)	archive_label Meta Archive
			mar -t "$f"
			;;

		# See http://www.dakotacom.net/~donut/programs/par2ls.html
		# requires: par2ls
		# (Untested)
		*.par2)	archive_label Parity Archive ver. 2
			par2ls "$f"
			;;

		# See http://www.pcbsd.org/
		# requires: sed, bzip2
		*.pbi) archive_label PC-BSD package
			sed '1,/^__PBI_ARCHIVE__$/d' "$f" | bzip2 -dc | tar xOf - Package.tar | tar tvf -
			;;

		# (Don't know what kind of suffix this one uses)
		# (Untested)
		*.pkg)	archive_label SysV packager '(SCO UNIX, IRIX)'
			pkginfo -d "`dirname "$f"`" -l "`basename "$f"`"
			;;

		# requires: paq6
		# See http://www.cs.fit.edu/~mmahoney/compression/#paq6
		*.pq6)	archive_label PAQ6 compressed archive
			sed '//,$d' "$f"
			;;

		# requires: unrar
		*.rar)	archive_label RAR compressed archive
			unrar l "$f"
			;;

		# See http://www.rpm.org/
		# requires: rpm
		*.rpm | *.spm)	archive_label Red Hat RPM package
		rpm -qilvp "$f"
			;;

		# (Obsolete format; from Red Hat Linux distributions < 4.0)
		# See http://www.redhat.com/
		# requires: tar, cpio, gzip
		*.rpp)	archive_label Red Hat RPP package
			tar xOf "$f" cpio-archive.gz | gzip -dc | cpio --list --verbose
			;;

		# See http://rzip.samba.org/
		# requires: python >= 1.6
		*.rz)	archive_label rzip archive
			python - "$f" <<EOF
import struct, sys, os, string
fn=sys.argv[1]
f=open(fn)
magic,ver1,ver2 = struct.unpack('4sBB', f.read(6))
if magic!='RZIP': sys.stderr.write('Not an rzip archive\n'); sys.exit(1);
length = struct.unpack('!II', f.read(8))
basefn=os.path.basename(fn)
basefn=basefn[:string.rfind(basefn,'.')]
print 'rz ver    length filename'
print '%2d.%02d %10d %s' % (ver1,ver2, length[1] * 0x100000000L + length[0], basefn)
EOF
			;;

		# requires: DumpSIS (http://www.geocities.com/jfldars/dumpsis.html)
		*.sis)	archive_label SymbianOS SIS installable package
			DumpSIS.pl "$f"
			;;

		# requires: macutils
		*.sit)	archive_label Macintosh StuffIt archive
			macunpack -il "$f"
			;;

		# There are many kinds of shar archives with greatly differing
		# formats. This code attempts to find a manifest listing in the
		# comments at the top of the file in several different formats.
		# requires: sed
		*.shar | *.sh)	archive_label shell archive
			# display warning
			echo 'NOTE: shar contents listing is not completely reliable'
			# GNU shar 4.1
			sed -n -e '1,/^# This shar contains/d' -e '/^#$/,$d' -e 's/^# //p' "$f"
			# shar type A
			sed -n -e '1,/with \/bin\/sh/d' -e '/^#$/,$d' -e 's/^#[ 	]/	/p' "$f"
			# shar type B
			sed -n -e '/^#/!d' -e '/^# end of/d' -e 's/^#[ 	]//' -e '/^Contents/,$p' "$f"
			;;

		*.shk | *.sh2)	archive_label Apple II archive
			nulib tv "$f"
			;;

		# *.cbmarc extension is .arc, but that conflicts with SEA ARC
		# requires: fvcbm
		*.sda | *.sfx | *.d64 | *.x64 | *.t64 | *.lnx | *.lzh | \
		*.lha | *.n64 | *.lbr | *.[psrud]00 | \
		*.cbmarc)	archive_label Commodore 64 archive
			fvcbm "$f"
			;;

		# gzip-compressed tar archive
		# Also Netscape package .nif
		# Also eCos package .epk
		# Also QNX package .qpk
		# Also Frugalware package .fpm
		# Also HP-UX package .depot.gz
		# requires: tar, gzip
		*.nif | *.epk | *.qpk | *.depot.gz | *.fpm | \
		*.tar.z | *.tar.Z | *.tar.gz | *.tgz | *.taz) 
			archive_label gzip-compressed tar archive
			#tar tzvf "$f"
			gzip -dc "$f" | tar tvf -
			;;

		# bzip2-compressed tar archive
		# Also Stampede Linux package
		# requires: tar, bzip2
		*.slp | \
		*.tar.bz2 | *.tbz)	archive_label bzip2-compressed tar archive
			bzip2 -dc "$f" | tar tvf -
			;;

		# tar archive .tar
		# Also tardist IRIX package .tardist
		# requires: tar
		*.tar | *.tardist)	archive_label tar archive
			tar tvf "$f"
			;;

		# See http://tnef.sourceforge.net/
		# requires: tnef
		# (Untested)
		*winmail.dat)	archive_label Microsoft TNEF e-mail attachment
			tnef -t "$f"
			;;

		# requires: sed
		*.uu | *.uue | *.uua)	archive_label uuencoded file
			sed -n 's/^begin //p' "$f"
			;;

		# zip archive .zip
		# Also Java jar file .jar
		# Also Mozilla Java Cross Platform Installer .xpi
		# Also Perl package .par
		# Also Winamp compressed skin file .wsz,.wal
		# Also Google Earth .kmz
		# Also OpenOffice Impress Presentation .sxi
		# Also OpenOffice Drawing .sxd
		# requires: unzip
		*.zip | *.jar | *.xpi | *.par | *.wsz | *.wal | *.kmz | \
		*.sxi | *.sxd)
			archive_label ZIP archive
			unzip -v "$f"
			;;

		# requires: zoo
		*.zoo)	archive_label ZOO archive
			zoo -list "$f"
			;;

		# See http://debin.net/zzip/
		# requires: zzip
		# (Untested)
		*.zz)	archive_label ZZIP archive
			zzip l "$f"
			;;

# Compressed files must come after compressed archives

		# requires: gzip
		*.gz | *.Z | *.z)	archive_label gzip-compressed file
			gzip -vl "$f"
			;;

		# requires: fileutils, textutils, sh-utils, sed
		*.bz2)	archive_label bzip2-compressed file
		    if [ -e "$f" ] ; then
				echo "method  crc      date           compressed uncompressed_name"
				FILEINFO=`ls -l "$f"`
				#FILESIZE=`echo "$FILEINFO" | cut -c 30-42`
				FILESIZE=`echo "$FILEINFO" | awk '{print $5}'`
				#FILEDATE=`echo "$FILEINFO" | cut -c 43-54`
				FILEDATE=`echo "$FILEINFO" | awk '{print $6 " " $7 " " $8}'`
				FILENAME=`basename "$f" .bz2`
				#FILECRC=`od -A n -j 10 -N 4 -t x1 "$f" | sed "s/ //g"`
				FILECRC=`hexdump -e '4/1 "%02x" "\n"' -n 4 -s 10 "$f"`
				#FILECOMPRESS=`od -A n -j 3 -N 1 -t c "$f" | sed "s/ //g"`
				FILECOMPRESS=`hexdump -e '"%_c" "\n"' -n 1 -s 3 "$f"`
				printf "bzip2-%s %8s %s %13s %s" "$FILECOMPRESS" "$FILECRC" "$FILEDATE" "$FILESIZE" "$FILENAME"
			else
				echo "$f: No such file or directory"
			fi
			;;

# Unknown format
		*)	echo "$filetype: Unsupported archive format." 1>&2
			if [ X"$FV_VERBOSE" = X1 ] ; then
				file "$f" 1>&2
			fi
			# Indicate that an error has occurred
			false
			;;

	esac
	# Save the return code of the last program run so we can return that from
	# the script. This won't work for some of the archive listers, but it's
	# better than nothing.
	rc=$?
	echo ""
done
exit $rc
